FROM docker.io/archlinux

MAINTAINER https://github.com/dracutdevs/dracut

# install aur helper to allow easy install of aur packages
RUN pacman --noconfirm -Syu base-devel git
RUN useradd -m build && echo "build ALL=(ALL) NOPASSWD: /usr/bin/pacman" > "/etc/sudoers.d/allow_pacman"
RUN su build -c 'cd && git clone https://aur.archlinux.org/paru-bin.git && cd paru-bin && makepkg -s --noconfirm' && pacman -U --noconfirm ~build/paru-bin/*.pkg.tar.*

COPY tools/* /tmp/
WORKDIR /tmp

# Install needed packages for the dracut CI container
# Assume that initramfs virtual package is installed so that the default mkinitcpio package does not get installed
RUN su build -c 'paru --needed --noconfirm -Syu --assume-installed initramfs `/tmp/test-packages.sh` ' \
    && yes | paru -Sccd
